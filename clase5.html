<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Fundamentos contenedores Docker - CFL 410 - Clase 5</title>
    <!-- <link rel="icon" type="image/x-icon" href="/img/logos/IDEPInformaticaLogo.png"> -->
    <link rel="icon" type="image/x-icon" href="/img/logos/page.png">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/white.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/egg.css">

    <!-- CLASE AUN NO DISPONIBLE-->
    <!-- <meta http-equiv="refresh" content="0; url=./404.html"> -->

</head>

<body>

    <!-- CLASE AUN NO DISPONIBLE-->
    <!-- <script>
            window.location.href = "/404.html";
        </script> -->

    <div class="reveal">
        <div class="slides">

            <section>

                <section id="inicio" data-state="customevent" data-transition="slide"
                    data-background-gradient="radial-gradient(#ffffff, #dcffdc)" data-background-size="contain">

                    <h3>Fundamentos y usos prácticos de Docker</h3>
                    <h4>Clase 5 : Persistencia de datos</h4>

                </section>

                <section id="index" data-state="no_footer">
                    <h3>Temas de clase 5:</h3>

                    <p>

                    <h4>Persistencia de datos</h4>
                    <small>
                        <ul>
                            <li><a href="#/intro_mounts">Administrar datos en Docker</a></li>
                            <li><a href="#/mounts_types">Tipos de montaje</a></li>
                            <li><a href="#/volumes">Volumenes</a></li>
                            <li><a href="#/bind_mounts">Bind mounts</a></li>
                            <li><a href="#/volumenes">Gestión de volumenes</a></li>
                        </ul>

                        </p>
                        <a href="#/labs_clase">Laboratorios</a>
                        <p><a href="?print-pdf">Exportar clase</a></p>
                    </small>

                </section>

            </section>


            <section>
                <section id="volumenes" data-state="customevent" data-transition="slide"
                    data-background-gradient="radial-gradient(#ffffff, #dcffdc)" data-background-size="contain">
                    <h3>Persistencia de datos</h3>
                    <h4>Volúmenes y bind mounts</h4>
                </section>

                <section id="intro_mounts" data-state="no_footer">
                    <h3>Persistencia de datos</h3>
                    <small>
                        <p>En Docker, el manejo del almacenamiento es crucial para persistir datos más allá del ciclo de
                            vida de un contenedor. Dado que los contenedores son efímeros y todos los cambios de
                            archivos dentro de un contenedor se pierden cuando el contenedor se elimina, Docker ofrece
                            varias opciones para persistir estos datos de manera segura. La Doc los llama de forma
                            abarcativa como <em>mounts</em>.</p>
                    </small>
                    <img src="./img/clase5/persistence.png" width="70%">
                </section>


                <section id="mounts_types" data-state="no_footer">
                    <h3>Tipos de Mounts</h3>
                    <small>
                        <p>Docker soporta tres tipos de mounts:</p>

                        <ul>
                            <li>Volumes</li>
                            <li>Bind Mounts</li>
                            <li>tmpfs mounts</li>

                        </ul>

                    </small>

                    <p><img src="./img/clase5/mounts.png" width="50%"></p>

                    <small><a href="https://docs.docker.com/engine/storage/" target="_blank">Docker Docs: Manage data in
                            Docker</a></small>

                </section>

                <section id="volumes" data-state="no_footer">
                    <h3>Volumes</h3>
                    <small>
                        <p>Los volúmenes son el mecanismo preferido para conservar los datos generados y utilizados por
                            los contenedores Docker *<a href="https://docs.docker.com/engine/storage/volumes/"
                                target="_blank">[1]</a>.</p>

                        <ul>
                            <li>Son gestionados completamente por Docker</li>
                            <li>Se almacenan en una ubicación específica en el host
                                <code>/var/lib/docker/volumes/</code>
                            </li>
                            <li>Pueden ser creados explícitamente o al momento de crear un contenedor o mediante un
                                archivo compose.</li>
                        </ul>


                    </small>
                    <img src="./img/clase5/volumes1.png">
                </section>

                <section id="volumes_ventajas" data-state="no_footer">

                    <h3>Volumes: Ventajas</h3>
                    <small>
                        <ul>
                            <!-- <li>Es mas fácil realizar copias de seguridad o migrar volúmenes respecto a otro tipo de mounts.</li> -->
                            <li>Podemos administrar volúmenes utilizando los comandos de Docker CLI o la API de Docker.
                            </li>
                            <li>Funciona en contenedores Linux y Windows</li>
                            <li>Los volúmenes se pueden compartir de forma más segura entre varios contenedores.</li>
                            <li>Los volumes permiten almacenarse en hosts remotos o proveedores de nube, cifrar el
                                contenido de los volúmenes o agregar otras funciones. (AWS S3, <a
                                    href="https://docs.docker.com/engine/storage/volumes#create-cifssamba-volumes">CIFS/Samba</a>,
                                <a
                                    href="https://docs.docker.com/engine/storage/volumes#create-a-service-which-creates-an-nfs-volume">NFS</a>,
                                <a href="https://docs.docker.com/engine/storage/volumes#block-storage-devices">Block
                                    devices</a>,
                                etc)
                            </li>
                            <li>Buena performance I/O</li>
                            <li>Los volumes en Docker Desktop tiene una mejor performance en host Windows y Mac.
                            </li>
                            <li>Tienen diversas opciones de configuración como permisos, conectar a comparticiones de
                                red y servicios en la nube, etc.</li>
                            <li>Fácil de realizar backups, restores y migraciones. <a
                                    href="https://docs.docker.com/engine/storage/volumes#back-up-restore-or-migrate-data-volumes"
                                    target="_blank">[1]</a></li>
                            <li>Es posible montar una parte de volumen (subdirectorio) a un contenedor. <a
                                    href="https://docs.docker.com/engine/storage/volumes#mount-a-volume-subdirectory"
                                    target="_blank">[2]</a></li>

                        </ul>
                    </small>

                    <p><small><a href="https://docs.docker.com/engine/storage/volumes/" target="_blank">Docker Docs:
                                Volumes</a></small></p>

                </section>



                <section id="bind_mounts" data-state="no_footer">

                    <h3>Bind Mounts</h3>
                    <small>
                        <!-- <p></p> -->
                        <ul>
                            <li>Montan un directorio específico del host en un contenedor.</li>
                            <li>Se definen con rutas absolutas (o relativas) del sistema de archivos del host.</li>
                            <li>Ofrecen más flexibilidad pero menos aislamiento, ya que exponen directorios específicos
                                del host al contenedor.</li>
                            <li>Datos fácilmente accesible, pero menor seguridad.</li>
                            <li>No hace falta crear volumenes, simplemente toma los datos del filesystem del host.</li>

                        </ul>
                    </small>
                    <img src="./img/clase5/bind_mounts.png">

                    <p><small><a href="https://docs.docker.com/engine/storage/bind-mounts/" target="_blank">Docker Docs:
                                Bind mounts</a></small></p>

                </section>

                <section id="tmpfs_mounts" data-state="no_footer">

                    <h3>tmpfs Mounts</h3>
                    <small>
                        <!-- <p></p> -->
                        <ul>
                            <li>Montan un sistema de archivos en memoria.</li>
                            <li>Son útiles para datos temporales que no deben persistir entre reinicios del contenedor.
                            </li>
                        </ul>
                        <p>Limitaciones:</p>
                        <ul>
                            <li>No es posible compartir tmpfs mounts entre contenedores</li>
                            <li>Solo está disponible en host Linux</li>

                        </ul>
                    </small>
                    <img src="./img/clase5/mounts.png" width="50%">

                    <p><small><a href="https://docs.docker.com/engine/storage/tmpfs/" target="_blank">Docker Docs: tmpfs
                                mounts</a></small></p>

                </section>

                <section id="ipreguntas3" data-state="no_footer">
                    <h2>Consultas</h2>
                </section>

            </section> <!-- Fin Sección-->

            <section>
                <section id="volumenes" data-state="customevent" data-transition="slide"
                    data-background-gradient="radial-gradient(#ffffff, #dcffdc)" data-background-size="contain">
                    <h3>Gestión de volumenes Docker</h3>
                    <h4>Comandos básicos</h4>
                </section>

                <section id="volume_create" data-state="no_footer">
                    <h3>Crear volumenes</h3>
                    <small>
                        <p>Docker nos provee mecanismos desde la Docker CLI para gestionar volúmenes. Vamos a crear un
                            volumen llamado "my_volume".</p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker volume create my_volume
                    </code></pre>

                    <h4>Listar volumenes</h4>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker volume ls
                    </code></pre>

                    <small>
                        <p><a href="https://docs.docker.com/reference/cli/docker/volume/create/" target="_blank">Docker
                                Docs: volume create</a></p>
                        <p><a href="https://docs.docker.com/reference/cli/docker/volume/ls/" target="_blank">Docker
                                Docs: volume ls</a></p>
                    </small>


                </section>

                <section id="volume_mount" data-state="no_footer">
                    <h3>Montar volumenes</h3>
                    <small>
                        <p>Si usamos el comando <strong>docker run</strong>, podemos elegir entre
                            los flags <strong>--mount</strong> y <strong>--volume</strong>.
                        </p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run --mount type=volume,src=&lt;volume-name&gt;,dst=&lt;mount-path&gt;
                        docker run --volume &lt;volume-name&gt;:&lt;mount-path&gt;
                    </code></pre>

                    <small>
                        <p><a href="https://docs.docker.com/engine/storage/volumes/#syntax" target="_blank">Docker
                                Docs: volume syntax</a></p>
                    </small>
                </section>

                <section id="volume_mount1" data-state="no_footer">
                    <h3>Montar volumenes, readonly</h3>
                    <small>
                        <p>Diferencias entre <strong>--mount</strong> y <strong>--volume</strong></p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run -d \
                          -v ng-vol:/usr/share/nginx/html:ro \
                          nginx:latest
                    </code></pre>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run -d \
                          --mount source=ng-vol,destination=/usr/share/nginx/html,readonly \
                          nginx:latest
                    </code></pre>

                    <small>
                        <p>El flag <strong>ro</strong> es un alias de <strong>readonly</strong>. Con esas opciones
                            indicamos que el contenedor no podrá modificar el contenido del volumen.</p>
                    </small>

                    <small>
                        <p><a href="https://docs.docker.com/engine/storage/volumes/#options-for---mount"
                                target="_blank">Docker Docs: mount options</a></p>
                        <p><a href="https://docs.docker.com/engine/storage/volumes/#options-for---volume"
                                target="_blank">Docker Docs: volume options</a></p>
                        <p><a href="https://docs.docker.com/engine/storage/volumes/#use-a-read-only-volume"
                                target="_blank">Docker Docs: use a read-only volume</a></p>
                    </small>
                </section>

                <section id="volume_mount2" data-state="no_footer">
                    <h3>Montar volumenes en contenedores</h3>
                    <small>
                        Vamos a montar el volumen <strong>my_volume</strong> en un contenedor.
                    </small>
                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                            docker run --rm -it -v my_volume:/home alpine sh
                        </code></pre>
                    <small>
                        Ahora hagamos un cambio en el volumen y salimos del contenedor
                    </small>
                    <pre class="codigo_shadow" data-id="code-animation"><code class="bash codigo-redondo" data-trim>
                        touch /home/mensaje.txt # Creamos un archivo vacío mensaje.txt
                        exit # Salimos del contenedor. Se borrará --rm
                    </code></pre>
                    <small>Ejecutamos un contenedor completamente diferente con el mismo volumen montado.</small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run --rm -it -v my_volume:/home ubuntu bash
                        ls -l /home
                    </code></pre>

                    <div class="fragment">
                        <small>¿Qué ha ocurrido?<span class="fragment"> Hemos logrado persistir datos y montar el
                                volumen en otro contenedor completamente diferente.</span></small>
                        <small class="fragment">
                            <p><a href="https://docs.docker.com/engine/storage/volumes/#choose-the--v-or---mount-flag"
                                    target="_blank">Docker Docs: mount</a></p>
                        </small>
                    </div>


                </section>

                <section id="volumes_notas" data-state="no_footer">
                    <h3>Volumes: Datos pre-existentes</h3>
                    <small>
                        <p>Los volumes se montan sobre un path o directorio (punto de montaje) de <a
                                href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">Linux</a>. Ese lugar
                            en el
                            filesystem del
                            contenedor puede tener datos pre-existentes o no.</p>
                        <ul>
                            <li>Si montamos un volumen vacío sobre un punto de montaje con datos pre-existentes, los
                                datos se copiarán automáticamente al volumen.</li>
                            <li>Si montamos un volumen con datos sobre un punto de con datos pre-existentes,
                                los datos pre-existentes se "enmascaran" por los datos del volumen. (Los datos que son
                                enmascarados no se borran).</li>
                            <li>En Docker no hay una forma sencilla de desmontar un volumen. Si queremos acceder a esos
                                datos que fueron "enmascarados" por el volumen, lo mejor es recrear el contenedor sin
                                montar el volumen.</li>

                            <li>Si al iniciar un contenedor especificamos un volumen que no existe, Docker lo creará
                                automáticamente.</li>
                        </ul>

                    </small>
                    <p><small><a href="https://docs.docker.com/engine/storage/volumes#mounting-a-volume-over-existing-data"
                                target="_blank">Docker Docs:
                                Mounting a volume over existing data</a></small></p>
                </section>

                <section id="volume_bind" data-state="no_footer">
                    <h3>Montar bind mounts</h3>
                    <small>
                        <p>Podemos montar directorios del host en el contenedor.</p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run --rm -v ./carpeta:/app -it alpine sh
                    </code></pre>

                    <small>
                        <p>Si estamos en Windows el comando es diferente:.</p>
                    </small>
                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run --rm -v "${PWD}/carpeta:/app" -it alpine sh
                    </code></pre>

                    <small>
                        <p>En ambos casos, el directorio carpeta se monta en el contenedor en la ruta /app. Y los
                            cambios que hagamos en la carpeta del host se verán reflejados en el contenedor.
                        </p>
                    </small>

                    <small>
                        <p><a href="https://docs.docker.com/get-started/workshop/06_bind_mounts/" target="_blank">Docker
                                Docs: bind mounts</a></p>
                    </small>
                </section>



                <section id="volume_rm" data-state="no_footer">
                    <h3>eliminar volumen</h3>
                    <small>
                        <p>No debe haber ningún contenedor utilizando el volumen. Antes de eliminar el volumen,
                            probablemente tengamos que eliminar los contenedores que lo tengan montado aunque no estén
                            corriendo.</p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker volume rm VOLUME_NAME
                    </code></pre>


                    <p><small><a href="https://docs.docker.com/reference/cli/docker/volume/rm/" target="_blank">Docker
                                Docs: volume rm</a></small></p>

                    <h4>Eliminar volumenes utilizados</h4>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker volume prune
                    </code></pre>

                    <p><small><a href="https://docs.docker.com/reference/cli/docker/volume/prune/"
                                target="_blank">Docker Docs: volume prune</a></small></p>



                </section>

                <section id="volume_inspect" data-state="no_footer">

                    <h3>Inspeccionar volumen</h3>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker volume inspect VOLUME_NAME
                    </code></pre>
                    <small>Info brindada:</small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="json codigo-redondo" data-trim>
                                "CreatedAt": "2024-08-23T09:49:48-03:00",
                                "Driver": "local",
                                "Labels": null,
                                "Mountpoint": "/var/lib/docker/volumes/my_volume/_data",
                                "Name": "my_volume",
                                "Options": null,
                                "Scope": "local"
                    </code></pre>

                    <p><small><a href="https://docs.docker.com/reference/cli/docker/volume/inspect/"
                                target="_blank">Docker Docs: volume inspect</a></small></p>



                </section>

                <section id="docker_cp" data-state="no_footer">

                    <h3>Copiar archivos a contenedores</h3>

                    <small>
                        <p>Podemos copiar contenido de nuestro host hacia un contenedor con el comando
                            <code>docker cp [OPTIONS] [PATH] CONTAINER:/[DESTINATION]</code>
                        </p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker cp config.json contenedor_prueba:/mnt
                    </code></pre>

                    <small>
                        <p>O a la inversa, copiar desde el contenedor hacia el host invirtiendo los paths</p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker cp contenedor_prueba:/mnt/config.json .
                    </code></pre>

                    <small>
                        <p>Esto no es exclusivo de los volúmenes. Se pueden copiar a cualquier path del contenedor por
                            mas que no tenga un volumen montado.</p>
                    </small>

                    <p><small><a href="https://docs.docker.com/reference/cli/docker/container/cp/"
                                target="_blank">Docker Docs: container cp</a></small></p>

                </section>

                <!-- <section id="volume_bkp" data-state="no_footer">
                    <h3>Backup, restore, migrate</h3>
                    <small>
                        <p>Los volumenes son útiles para backups, restores y migrationes. Se usa el flag
                            <strong>--volumes-from</strong> para crear un nuevo contenedor que monte ese volumen.
                        </p>
                    </small>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run -v /dbdata --name dbstore ubuntu /bin/bash
                    </code></pre>

                    <pre class="codigo_shadow" data-id="code-animation"><code class="docker codigo-redondo" data-trim>
                        docker run --rm --volumes-from dbstore -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /dbdata
                    </code></pre>

                    <small>
                        <p><a href="https://docs.docker.com/engine/storage/volumes#back-up-restore-or-migrate-data-volumes"
                                target="_blank">Docker Docs: backup, restore or migrate data volumes</a></p>
                    </small>
                </section> -->

                <section id="ipreguntas4" data-state="no_footer">
                    <h2>Consultas</h2>
                </section>
            </section> <!-- Fin sección-->




            <section id="labs_clase" data-state="no_footer">
                <h3>Actividad de práctica:</h3>
                <small>
                    <ul>

                        <li><a href="https://github.com/kity-linuxero/docker_410_practicas/blob/v1.5/labs/05-volumes/51-volumenes_docker.md"
                                target="_blank">Lab 5.1</a> Persistencia de datos en Docker</li>
                        <li><a href="https://github.com/kity-linuxero/docker_410_practicas/blob/v1.5/labs/05-volumes/52-volumenes_bkp.md"
                                target="_blank">Lab 5.2</a> Backup y Migración de Volúmenes</li>

                    </ul>

                </small>




            </section>

            </section>

            <section id="fin" data-state="hide_footer" data-transition="slide"
                data-background-gradient="radial-gradient(#ffffff, #dcffdc)" data-background-size="contain">
                <a href="index.html"><img src="img/logos/idep_logo.png" width="40%" height="40%"></a>
            </section>



        </div>
    </div>

    <footer>
        <!-- Logos en el footer -->
        <div id="logos-footer" class="footer">
            <span class="element"><img src="img/logos/cfl_logo.png" class="foot-image"></span>
            <span class="element"><img src="img/logos/IDEPInformaticaLogo.png" class="foot-image-idep-info"></span>
            <span class="element"><img src="img/logos/ate_logo.svg" class="foot-image"></span>
        </div>

        <script type="text/javascript">
            window.addEventListener("load", function () {

                revealDiv = document.querySelector("body div.reveal")
                footer = document.getElementById("logos-footer");
                revealDiv.appendChild(footer);

            });
        </script>
    </footer>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script src="plugin/zoom/zoom.js"></script>
    <script src="plugin/copycode/copycode.js"></script>


    <script>
        // More info about initialization & config:
        // - https://revealjs.com/initialization/
        // - https://revealjs.com/config/

        // Para eventos personalizados. Indica que está en la presentación

        Reveal.on('customevent', function () {
            var element = document.getElementById("logos-footer");
            element.style.display = "table";
            element.style.opacity = "40%";

        });

        Reveal.on('hide_footer', function () {
            var element = document.getElementById("logos-footer");
            element.style.display = "table";
            element.style.opacity = "0%";

        });

        Reveal.on('no_footer', function () {
            var element = document.getElementById("logos-footer");
            //element.style.display = "none";
            // element.style.display = "table";
            element.style.opacity = "15%";
        });
        Reveal.initialize({
            hash: true,

            copycode: {
                button: "hover",
                display: "icons",
                text: {
                    copy: "Copiar",
                    copied: "¡Copiado!",
                },
                plaintextonly: true,
                timeout: 1000,
                style: {
                    copybg: "gray",
                    copiedbg: "green",
                    copycolor: "black",
                    copiedcolor: "white",
                    copyborder: "",
                    copiedborder: "",
                    scale: 1,
                    offset: 0,
                    radius: 0.2
                },
                tooltip: true,
                iconsvg: {
                    copy: '',
                    copied: ''
                },
                cssautoload: true,
                csspath: "",
                clipboardjspath: ""
            },

            // Learn about plugins: https://revealjs.com/plugins/
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom, CopyCode]
        });
    </script>

</body>

</html>